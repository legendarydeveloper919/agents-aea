apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: ph-deployment-name-here
  namespace: ph-deployment-namespace-here
  labels:
    app: ph-deployment-name-here
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ph-deployment-name-here 
  template:
    metadata:
      labels:
        app: ph-deployment-name-here

    spec:
      initContainers:
      - name: check-entry-peer
        image: subfuzion/netcat
        command: ['sh', '-c', 
          'if [ -z "${LATEST_ENTRY_PEER_HOST}" ]; then exit 0; fi; until nc -w 2 -zv ${LATEST_ENTRY_PEER_HOST} ${LATEST_ENTRY_PEER_PORT}; do echo waiting for ${LATEST_ENTRY_PEER_HOST}:${LATEST_ENTRY_PEER_PORT} ; sleep 2; done;']
        env:
          - name: LATEST_ENTRY_PEER_HOST
            value: ph-latest-entry-peer-host-here
          - name: LATEST_ENTRY_PEER_PORT
            value: ph-latest-entry-peer-port-here
     
      containers:
      - image: ph-gcr-image-with-tag-here
        name: acn-node
        args: ["--config-from-env"]
        ports:
        - containerPort: ph-node-port-number-here
        - containerPort: ph-node-delegate-port-number-here

        resources:
          requests:
            memory: "64Mi"
            cpu: "150m"
          limits:
            memory: "4000Mi"
            cpu: "2000m"
        
        env:
          - name: AEA_P2P_ID 
            valueFrom:
              secretKeyRef:
                name: ph-node-priv-key-name-here
                key: priv-key
          - name: AEA_P2P_URI_PUBLIC
            value: ph-node-external-uri-here
          - name: AEA_P2P_URI
            value: ph-node-local-uri-here
          - name: AEA_P2P_DELEGATE_URI
            value: ph-node-delegate-uri-here
          - name: AEA_P2P_URI_MONITORING
            value: ph-node-monitoring-uri-here
          - name: AEA_P2P_ENTRY_URIS
            value: ph-node-entry-peers-list-here

      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: ph-deployment-name-here
  namespace: ph-deployment-namespace-here
spec:
  selector:
    app: ph-deployment-name-here
  ports:
    - name: libp2p 
      protocol: TCP
      port: ph-node-port-number-here
      targetPort: ph-node-port-number-here
    - name: tcp
      protocol: TCP
      port: ph-node-delegate-port-number-here
      targetPort: ph-node-delegate-port-number-here