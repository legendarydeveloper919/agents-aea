; By default, testenvs are configured to:
; - don't skip dist (skipsdist = False)
; - don't skip the package installation (skip_install = False)
; - don't use source installation (usedevelop = False)
; where one of those steps is not necessary for the test,
; we set the associated flag (e.g. for linting we don't need
; the package installation).
[tox]
envlist = bandit, black, black-check, isort, isort-check, flake8, liccheck, mypy, py{3.6,3.7,3.8,3.9}

[testenv]
basepython = python3
whitelist_externals = /bin/sh
passenv = *
extras = all
deps =
    pytest==5.3.5
    pytest-cov==2.8.1
    pytest-asyncio==0.10.0
    pytest-randomly==3.2.1
    docker==4.2.0

commands =
    pytest -rfE --doctest-modules ethereum_crypto \
           tests/ \
           --cov-report=html \
           --cov-report=xml \
           --cov-report=term \
           --cov-report=term-missing \
           --cov=ethereum_crypto \
           --cov-config=.coveragerc \
           {posargs}

[testenv:py3.6]
basepython = python3.6

[testenv:py3.7]
basepython = python3.7

[testenv:py3.7-cov]
basepython = python3.7
usedevelop = True

[testenv:py3.8]
basepython = python3.8

[testenv:py3.9]
basepython = python3.9

[testenv:bandit]
skipsdist = True
skip_install = True
deps = bandit==1.6.2
commands = bandit -r ethereum_crypto
           bandit -s B101 -r tests scripts

[testenv:black]
skipsdist = True
skip_install = True
deps = black==19.10b0
commands = black ethereum_crypto tests

[testenv:black-check]
skipsdist = True
skip_install = True
deps = black==19.10b0
commands = black ethereum_crypto tests --check --verbose

[testenv:isort]
skipsdist = True
skip_install = True
deps = isort==5.5.2
commands = isort aea benchmark examples packages plugins scripts tests

[testenv:isort-check]
skipsdist = True
skip_install = True
deps = isort==5.5.2
commands = isort --check-only --verbose aea benchmark examples packages plugins scripts tests

[testenv:flake8]
skipsdist = True
skip_install = True
deps = flake8==3.7.9
       flake8-bugbear==20.1.4
       flake8-docstrings==1.5.0
       flake8-eradicate==0.4.0
       flake8-isort==4.0.0
       pydocstyle==3.0.0
commands = flake8 ethereum_crypto tests

[testenv:liccheck]
skipsdist = True
usedevelop = True
deps = liccheck==0.4.3
commands = {toxinidir}/scripts/freeze_dependencies.py -n ethereum_crypto -o {envtmpdir}/requirements.txt
           liccheck -s strategy.ini -r {envtmpdir}/requirements.txt -l PARANOID

[testenv:mypy]
skipsdist = True
skip_install = True
deps = mypy==0.761
commands = mypy ethereum_crypto tests

[testenv:pylint]
whitelist_externals = /bin/sh
skipsdist = True
deps = pylint==2.5.2
       pytest==5.3.5
commands = sh -c "pylint ethereum_crypto --disable=E1136"

[testenv:safety]
skipsdist = True
skip_install = True
deps = safety==1.8.5
commands = safety check -i 37524 -i 38038 -i 37776 -i 38039

[testenv:vulture]
skipsdist = True
skip_install = True
deps = vulture==2.1
commands = vulture ethereum_crypto scripts/whitelist.py
